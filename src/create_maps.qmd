---
title: "create_maps"
format: html
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE) # no warnings or messages 

knitr::opts_chunk$set(echo=FALSE) # not showing the code
```

```{r}
# Load pkgs 

if (!require(pacman)) install.packages("pacman")

pacman::p_load(leaflet, sf, readr, dplyr, here, glue,
               shiny
               #tigris
               )
```


```{r, echo = FALSE}
# Load data 

# Load county-level outcomes
df <- read.csv(here("raw_data", "cnty_counts_cov.csv"))

counties <- readr::read_rds(here("raw_data", "counties.rds"))

states <- readr::read_rds(here("raw_data", "states.rds"))

#list.files(here("raw_data"))

# Load county boundaries (US states from tigris package)

# counties <- counties(cb = TRUE)
# readr::write_rds(counties, here("raw_data", "counties.rds"))

# Load state boundaries (US states from tigris package)
# states <- states(cb = TRUE)
# write_rds(states, here("raw_data", "states.rds"))
```

# Create maps 

## Civic opportunity 

```{r}
# Ensure FIPS codes match
df$fips <- sprintf("%05d", df$FIPS)

# Merge datasets
map_data <- left_join(counties, df, by = c("GEOID" = "fips"))

# Merge state boundaries with map_data if necessary
map_data <- st_as_sf(map_data)  # Ensure it's an sf object
map_data <- st_transform(map_data, crs = st_crs(states))  # Match CRS
```

```{r}
# Create categorical bins (1 to 5)
map_data <- map_data %>%
  mutate(civic_opp_category = ntile(civic_opp_sum_normalized, 5))  # Divides into 5 groups (1-5)

# Define a color palette using colorFactor
pal <- colorFactor("YlOrRd", domain = map_data$civic_opp_category)
```

```{r}
civic_map <- leaflet(map_data) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~pal(civic_opp_category),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1
  ) %>%
  addPolygons(
    data = states,  # Overlay state boundaries
    color = "black",  # Boundary color
    weight = 1,
    fillOpacity = 0,  # Transparent fill
    label = ~NAME,  # Show state names on hover
    layerId = ~NAME
  ) %>%
  addLegend(
    pal = pal,
    values = map_data$civic_opp_category,
    title = "Civic Opportunity Index",
    labFormat = function(type, cuts, p) {
      paste0(cuts)  # Ensures numbers 1-5 appear in the legend
    }
  )
```

# Create an UI 

```{r}

ui <- fluidPage(
  leafletOutput("civic_map"),
  verbatimTextOutput("info")
)

server <- function(input, output, session) {
  
  output$civic_map <- renderLeaflet({
    civic_map %>%
      setView(lng = -95.7129, lat = 37.0902, zoom = 4) # Centered on the USA
  })
  
  observeEvent(input$civic_map_click, {
    click <- input$civic_map_click
    if (!is.null(click)) {
      
      info_text <- paste("Latitude:", 
                         round(click$lat, 2), 
                         "Longitude:", 
                         round(click$lng, 2))
      
      output$info <- renderText(info_text)
    }
  })
}

shinyApp(ui, server)
```