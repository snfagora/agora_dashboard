---
title: "Civic Opportunity Map"
format:
  html:
    page-layout: full
    self-contained: false
    theme: default
execute:
  echo: false
  warning: false
  message: false
---

```{r setup, include=FALSE}
# Load necessary packages
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(
  leaflet, leaflet.extras, glue, sf, tigris, tidyverse, here, htmlwidgets, viridis, 
  RColorBrewer, htmltools
)

# Set a consistent theme for plots (if needed)
theme_set(theme_minimal())
```

```{r}
# Load and prepare civic opportunity data
civic_data <- tryCatch({
  read.csv(here::here("raw_data", "cnty_counts_cov.csv")) %>%
    mutate(fips = sprintf("%05d", FIPS))  # Ensure FIPS codes are 5 digits
}, error = function(e) {
  stop("Error loading civic opportunity data: ", e$message)
})

# Load spatial data for counties and states
counties <- tryCatch({
  readr::read_rds(here::here("raw_data", "counties.rds")) %>%
    st_transform(4326)
}, error = function(e) {
  stop("Error loading counties data: ", e$message)
})

states <- tryCatch({
  readr::read_rds(here::here("raw_data", "states.rds")) %>%
    st_transform(4326)
}, error = function(e) {
  stop("Error loading states data: ", e$message)
})

# Load and aggregate organization type data
org_type_data <- tryCatch({
  read.csv(here::here("raw_data", "cnty_civic_org_type.csv"))
}, error = function(e) {
  stop("Error loading organization type data: ", e$message)
})

# Aggregate primary organization type
top3_orgs <- org_type_data %>%
  filter(!is.na(class)) %>%
  group_by(FIPS, class) %>%
  summarise(freq = sum(freq, na.rm = TRUE), .groups = "drop") %>%
  group_by(FIPS) %>%
  mutate(
    total_freq = sum(freq),
    pct = freq / total_freq
  ) %>%
  arrange(FIPS, desc(freq)) %>%
  slice_head(n = 3) %>%
  mutate(rank = row_number()) %>%
  ungroup()

aggregated_data <- top3_orgs %>%
  mutate(
    rank_label = case_when(
      rank == 1 ~ "primary",
      rank == 2 ~ "second",
      rank == 3 ~ "third"
    )
  ) %>%
  select(FIPS, rank_label, class, pct) %>%
  pivot_wider(
    names_from = rank_label,
    values_from = c(class, pct),
    names_glue = "{rank_label}_org_{.value}"
  )

# Join civic data with counties
map_data_civic <- counties %>%
  left_join(civic_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  mutate(
    civic_opp_category = ntile(civic_opp_sum_normalized, 5),
    civic_opp_index = civic_opp_category,
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  ) %>%
  st_simplify(dTolerance = 0.1)

# Add national and state rankings
map_data_civic <- map_data_civic %>%
  group_by(STUSPS) %>%
  mutate(
    state_rank = rank(desc(civic_opp_sum_normalized), ties.method = "min"),
    state_total = n()
  ) %>%
  ungroup() %>%
  mutate(
    national_rank = rank(desc(civic_opp_sum_normalized), ties.method = "min"),
    national_total = n()
  )

# Join organization type data with counties
aggregated_data <- aggregated_data %>%
  mutate(fips = sprintf("%05d", FIPS))

map_data_orgtype <- counties %>%
  left_join(aggregated_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  st_simplify(dTolerance = 0.1) %>%
  mutate(
    primary_org_class = factor(
      primary_org_class, 
      levels = c(
        "Religious", "Social & Fraternal", "Youth", "Unions", "Healthcare",
        "Economic", "Education", "Research & Think Tank", "Hobby & Sports", 
        "Community", "Foundations", "Professional", "Arts & Cultural", 
        "Housing", "Political", "NA"
      )
    )
  )

# Define color palettes
pal_green <- colorFactor(
  palette = RColorBrewer::brewer.pal(5, "Greens"),
  domain = map_data_civic$civic_opp_category,
  na.color = "lightgrey"
)

pal_primary_org <- colorFactor(
  palette = c(
    "darkgreen", "gold", "#FF7F00", "#E41A1C", "#984EA3", "#377EB8",
    "#4DAF4A", "#A65628", "#F781BF", "#999999", "#FFD700", "#1E90FF",
    "#FB9A99", "#B3DE69", "#FF69B4", "#CCCCCC"
  ),
  domain = levels(map_data_orgtype$primary_org_class),
  na.color = "lightgrey"
)

map_data_orgtype <- map_data_orgtype %>%
  left_join(
    map_data_civic %>% 
      st_drop_geometry() %>%
      select(GEOID, POV150, SNGPNT, NOHSDP, BROAD, UNEMP, REMNRTY),
    by = "GEOID"
  )

# Create the combined map
combined_map <- leaflet(options = leafletOptions(minZoom = 3, zoomControl = TRUE)) %>%
  addProviderTiles("CartoDB.Positron", group = "Base Map") %>%

  addPolygons(
    data = states,
    fill = FALSE,
    weight = 2,
    color = "#000000",
    opacity = 0.5,
    group = "State Boundaries",
    options = pathOptions(clickable = FALSE)
  ) %>%
  
  # Add Civic Opportunity Counts layer
  addPolygons(
    data = map_data_civic,
    fillColor = ~pal_green(civic_opp_category),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue(
      "<div style='font-size: 13px; line-height: 1.4; max-width: 300px;'>
        <h4 style='margin-bottom: 6px;'>{NAMELSAD}, {STUSPS}</h4>
    
        <p><strong>Civic Opportunity Index:</strong> {civic_opp_index} ({civic_opp_percentile_label})</p>
        <p><strong>Total Civic Opportunity Orgs:</strong> {civic_org_sum} of {n} nonprofits</p>
        <p><strong>State Rank:</strong> {scales::comma(state_rank)} / {scales::comma(state_total)}</p>
        <p><strong>National Rank:</strong> {scales::comma(national_rank)} / {scales::comma(national_total)}</p>
        
        <p><u><strong>Civic Opportunity Types (counts):</strong></u><br/>
       Volunteer organization #: {volunteer_sum}<br/>
       Membership organization #: {membership_sum}<br/>
       Take Action organization #: {take_action_sum}<br/>
       Public events organization #: {events_sum}</p>
    
        <p><u><strong>Sociodemographic Indicators (%):</strong></u><br/>
       Poverty: {round(POV150, 1)}%<br/>
       Single Parents: {round(SNGPNT, 1)}%<br/>
       No HS Diploma: {round(NOHSDP, 1)}%<br/>
       Without Broadband: {round(BROAD, 1)}%<br/>
       Unemployed: {round(UNEMP, 1)}%<br/>
       Non-White Share: {round(REMNRTY, 1)}%</p>
        </p>
      </div>"
    ),
    label = ~NAMELSAD,
    group = "Civic Opportunity Counts"
  ) %>%
  
  # Add Primary Organization Type layer
  addPolygons(
    data = map_data_orgtype,
    fillColor = ~pal_primary_org(primary_org_class),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue(
      "<div style='font-size: 13px; line-height: 1.4; max-width: 300px;'>
        <h4 style='margin-bottom: 6px;'>{NAMELSAD}, {STUSPS}</h4>
    
        <p><u><strong>Top Civic Opportunity Organiztion Types:</strong></u><br/>
           1. {primary_org_class} ({round(primary_org_pct * 100, 1)}%)<br/>
           2. {second_org_class} ({round(second_org_pct * 100, 1)}%)<br/>
           3. {third_org_class} ({round(third_org_pct * 100, 1)}%)</p>
    
        <p><u><strong>Sociodemographic Indicators:</strong></u><br/>
       Poverty: {round(POV150, 1)}%<br/>
       Single Parents: {round(SNGPNT, 1)}%<br/>
       No HS Diploma: {round(NOHSDP, 1)}%<br/>
       Without Broadband: {round(BROAD, 1)}%<br/>
       Unemployed: {round(UNEMP, 1)}%<br/>
       Non-White Share: {round(REMNRTY, 1)}%</p>
        </p>
      </div>"
    ),
    label = ~NAMELSAD,
    group = "Organization Type"
  ) %>%
  
 # Modified legend additions with group attributes
  addLegend(
    position = "bottomright",
    pal = pal_green,
    values = map_data_civic$civic_opp_category,
    title = "Civic Opportunity Index",
    group = "Civic Opportunity Counts",
    className = "info legend civic-legend"  # Added class for identification
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal_primary_org,
    values = map_data_orgtype$primary_org_class,
    title = "Primary Organization Type",
    group = "Primary Organization Type",
    className = "info legend org-legend"    # Added class for identification
  ) %>%
  
   # Add layer toggle and hide org layer initially
  addLayersControl(
    baseGroups = c("Civic Opportunity Counts", "Primary Organization Type"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("Primary Organization Type") %>%  # hide org layer at start
  htmlwidgets::onRender("
    function(el, x) {
      var map = this;
      var civicLegend = document.querySelector('.civic-legend');
      var orgLegend = document.querySelector('.org-legend');
  
      function updateLegends(activeLayer) {
        if (activeLayer === 'Civic Opportunity Counts') {
          civicLegend.style.display = 'block';
          orgLegend.style.display = 'none';
        } else if (activeLayer === 'Primary Organization Type') {
          civicLegend.style.display = 'none';
          orgLegend.style.display = 'block';
        }
      }
  
      // Wait for map to initialize
      map.whenReady(function() {
        map.eachLayer(function(layer) {
          if (layer.options && layer.options.group === 'Civic Opportunity Counts') {
            map.addLayer(layer);
          }
        });
        updateLegends('Civic Opportunity Counts');
      });
  
      map.on('baselayerchange', function(e) {
        updateLegends(e.name);
      });
    }
  ") %>%
  # Add a sidebar for displaying popup content  
  htmlwidgets::onRender("
    function(el, x) {
      var map = this;
      function updateSidebar(content) {
        var sidebar = document.getElementById('popup-sidebar');
        if (sidebar) sidebar.innerHTML = content;
      }
      map.eachLayer(function(layer) {
        if (layer.getPopup && layer.getPopup()) {
          var popupContent = layer.getPopup().getContent();
          layer.unbindPopup(); // disable in-map popup
          layer.on('click', function() {
            updateSidebar(popupContent);
          });
        }
      });
    }
  ") %>%
  
  # Set the initial map view
  fitBounds(lng1 = -125, lat1 = 24, lng2 = -66.9, lat2 = 49) %>%
  
  addSearchFeatures(
  targetGroups = c("Civic Opportunity Counts", "Primary Organization Type"),
  options = searchFeaturesOptions(zoom = 7, openPopup = TRUE)
  )

```

```{r, echo = FALSE, fig.width = 20, fig.height = 20}
htmltools::browsable(
  htmltools::tagList(
    tags$style(HTML("
      #map-container, #popup-sidebar {
        height: 50vh;
        width: 100%;
      }

      #popup-sidebar {
        overflow-y: auto;
        padding: 1em;
        font-size: 14px;
        border-top: 1px solid #ccc;
        background-color: #f9f9f9;
      }

      @media (min-width: 768px) {
        .layout {
          display: flex;
          flex-direction: row;
          height: 90vh;
        }

        #map-container {
          width: 70%;
          height: 100%;
        }

        #popup-sidebar {
          width: 30%;
          height: 100%;
          border-top: none;
          border-left: 1px solid #ccc;
        }
      }
    ")),
    tags$div(
      class = "layout",
      tags$div(id = "map-container", combined_map),
      tags$div(id = "popup-sidebar", "Click a county to see details.")
    )
  )
)
```
