---
title: "Civic Opportunity Map"
format: 
  html:
    # Leaflet-specific options
    leaflet:
      center: [37.0902, -95.7129]  # Latitude and Longitude for the US center
      zoom: 4                     # Initial zoom level
      options:
        minZoom: 3                # Minimum zoom level
        zoomControl: true         # Enable zoom controls
execute:
  echo: false
  warning: false
  message: false
---

```{r setup, include=FALSE}
# Load necessary packages
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(
  leaflet, glue, sf, tigris, tidyverse, here, htmlwidgets, viridis, 
  RColorBrewer, htmltools
)

# Set a consistent theme for plots (if needed)
theme_set(theme_minimal())
```

```{r}
# Load and prepare civic opportunity data
civic_data <- tryCatch({
  read.csv(here::here("raw_data", "cnty_counts_cov.csv")) %>%
    mutate(fips = sprintf("%05d", FIPS))  # Ensure FIPS codes are 5 digits
}, error = function(e) {
  stop("Error loading civic opportunity data: ", e$message)
})

# Load spatial data for counties and states
counties <- tryCatch({
  readr::read_rds(here::here("raw_data", "counties.rds")) %>%
    st_transform(4326)
}, error = function(e) {
  stop("Error loading counties data: ", e$message)
})

states <- tryCatch({
  readr::read_rds(here::here("raw_data", "states.rds")) %>%
    st_transform(4326)
}, error = function(e) {
  stop("Error loading states data: ", e$message)
})

# Load and aggregate organization type data
org_type_data <- tryCatch({
  read.csv(here::here("raw_data", "cnty_civic_org_type.csv"))
}, error = function(e) {
  stop("Error loading organization type data: ", e$message)
})

# Aggregate primary organization type
top3_orgs <- org_type_data %>%
  filter(!is.na(class)) %>%
  group_by(FIPS, class) %>%
  summarise(freq = sum(freq, na.rm = TRUE), .groups = "drop") %>%
  group_by(FIPS) %>%
  mutate(
    total_freq = sum(freq),
    pct = freq / total_freq
  ) %>%
  arrange(FIPS, desc(freq)) %>%
  slice_head(n = 3) %>%
  mutate(rank = row_number()) %>%
  ungroup()

aggregated_data <- top3_orgs %>%
  mutate(
    rank_label = case_when(
      rank == 1 ~ "primary",
      rank == 2 ~ "second",
      rank == 3 ~ "third"
    )
  ) %>%
  select(FIPS, rank_label, class, pct) %>%
  pivot_wider(
    names_from = rank_label,
    values_from = c(class, pct),
    names_glue = "{rank_label}_org_{.value}"
  )

# Join civic data with counties
map_data_civic <- counties %>%
  left_join(civic_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  mutate(
    civic_opp_category = ntile(civic_opp_sum_normalized, 5),
    civic_opp_index = civic_opp_category,
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  ) %>%
  st_simplify(dTolerance = 0.05)

# Join organization type data with counties
aggregated_data <- aggregated_data %>%
  mutate(fips = sprintf("%05d", FIPS))

map_data_orgtype <- counties %>%
  left_join(aggregated_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  st_simplify(dTolerance = 0.05) %>%
  mutate(
    primary_org_class = factor(
      primary_org_class, 
      levels = c(
        "Religious", "Social & Fraternal", "Youth", "Unions", "Healthcare",
        "Economic", "Education", "Research & Think Tank", "Hobby & Sports", 
        "Community", "Foundations", "Professional", "Arts & Cultural", 
        "Housing", "Political", "NA"
      )
    )
  )

# Define color palettes
pal_green <- colorFactor(c("#D0F1C7", "#4CAF50", "#006400"), domain = map_data_civic$civic_opp_category)
pal_primary_org <- colorFactor(
  palette = c(
    "darkgreen", "gold", "#FF7F00", "#E41A1C", "#984EA3", "#377EB8",
    "#4DAF4A", "#A65628", "#F781BF", "#999999", "#FFD700", "#1E90FF",
    "#FB9A99", "#B3DE69", "#FF69B4", "#CCCCCC"
  ),
  domain = levels(map_data_orgtype$primary_org_class),
  na.color = "lightgrey"
)

# Create the combined map
combined_map <- leaflet(options = leafletOptions(minZoom = 3, zoomControl = TRUE)) %>%
  addProviderTiles("CartoDB.Positron", group = "Base Map") %>%
  
  # Add Civic Opportunity Counts layer
  addPolygons(
    data = map_data_civic,
    fillColor = ~pal_green(civic_opp_category),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue(
      "<b>{NAMELSAD}</b><br/>
      Civic Opportunity Index: {civic_opp_index}<br/>
      Civic Opportunity Percentile: {civic_opp_percentile_label}"
    ),
    label = ~NAMELSAD,
    group = "Civic Opportunity Counts"
  ) %>%
  
  # Add Primary Organization Type layer
  addPolygons(
    data = map_data_orgtype,
    fillColor = ~pal_primary_org(primary_org_class),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue(
      "<b>{NAMELSAD}</b><br/>
      Primary Organization Type: {primary_org_class}"
    ),
    label = ~NAMELSAD,
    group = "Primary Organization Type"
  ) %>%
  
 # Modified legend additions with group attributes
  addLegend(
    position = "bottomright",
    pal = pal_green,
    values = map_data_civic$civic_opp_category,
    title = "Civic Opportunity Index",
    group = "Civic Opportunity Counts",
    className = "info legend civic-legend"  # Added class for identification
  ) %>%
  addLegend(
    position = "bottomleft",
    pal = pal_primary_org,
    values = map_data_orgtype$primary_org_class,
    title = "Primary Organization Type",
    group = "Primary Organization Type",
    className = "info legend org-legend"    # Added class for identification
  ) %>%
  
  
  # Add layer controls
  addLayersControl(
    baseGroups = c("Civic Opportunity Counts", "Primary Organization Type"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  
  # Add JavaScript to toggle legends dynamically
  htmlwidgets::onRender("
    function(el, x) {
      var map = this;
      
      // Function to update legend visibility
      function updateLegends(activeLayer) {
        var civicLegend = document.querySelector('.civic-legend');
        var orgLegend = document.querySelector('.org-legend');
        
        if (activeLayer === 'Civic Opportunity Counts') {
          if (civicLegend) civicLegend.style.display = 'block';
          if (orgLegend) orgLegend.style.display = 'none';
        } else if (activeLayer === 'Primary Organization Type') {
          if (civicLegend) civicLegend.style.display = 'none';
          if (orgLegend) orgLegend.style.display = 'block';
        }
      }
      
      // Set initial legend state
      setTimeout(function() {
        updateLegends('Civic Opportunity Counts');
      }, 100);
      
      // Update legends when layer changes
      map.on('baselayerchange', function(e) {
        updateLegends(e.name);
      });
    }
  ") %>%
  
  # Set the initial map view
  fitBounds(lng1 = -125, lat1 = 24, lng2 = -66.9, lat2 = 49) 
```

```{r, echo=FALSE}
# Render the map
combined_map
```