---
title: "Civic Opportunity Map"
format: html
execute:
  echo: false
  warning: false
  message: false
---

```{r}
# Load necessary packages
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(leaflet, glue, sf, tigris, tidyverse, here, htmlwidgets, viridis, RColorBrewer, htmltools)

# Load and prepare data
civic_data <- read.csv(here::here("raw_data", "cnty_counts_cov.csv"))
civic_data$fips <- sprintf("%05d", civic_data$FIPS)

counties <- readr::read_rds(here::here("raw_data", "counties.rds")) %>% st_transform(4326)
states <- readr::read_rds(here::here("raw_data", "states.rds")) %>% st_transform(4326)

# Load civic org type data
org_type_data <- read.csv(here::here("raw_data", "cnty_civic_org_type.csv"))

# Aggregate primary org type
aggregated_data <- org_type_data %>%
  filter(!is.na(class)) %>%
  group_by(FIPS, class) %>%
  summarise(freq = sum(freq, na.rm = TRUE), .groups = "drop") %>%
  group_by(FIPS) %>%
  mutate(primary_org_type = class[which.max(freq)]) %>%
  ungroup() %>%
  select(FIPS, primary_org_type) %>%
  distinct()

# Join data
map_data_civic <- left_join(counties, civic_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  mutate(
    civic_opp_category = ntile(civic_opp_sum_normalized, 5),
    civic_opp_index = civic_opp_category,  # Needed for popup
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  ) %>%
  st_simplify(dTolerance = 0.01) 

aggregated_data$fips <- sprintf("%05d", aggregated_data$FIPS)

map_data_orgtype <- left_join(counties, aggregated_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  st_simplify(dTolerance = 0.01)

# Define color palettes
pal_green <- colorFactor(c("#D0F1C7", "#4CAF50", "#006400"), domain = map_data$civic_opp_category)

pal_primary_org <- colorFactor(
  palette = c(
    "darkgreen", "gold", "#FF7F00", "#E41A1C", "#984EA3", "#377EB8",
    "#4DAF4A", "#A65628", "#F781BF", "#999999", "#FFD700", "#1E90FF",
    "#FB9A99", "#B3DE69", "#FF69B4"
  ),
  domain = c(
    "Religious", "Social & Fraternal", "Youth", "Unions", "Healthcare",
    "Economic", "Education", "Research & Think Tank", "Hobby & Sports", 
    "Community", "Foundations", "Professional", "Arts & Cultural", 
    "Housing", "Political"
  )
)

# Create map 1
map1 <- leaflet(map_data_civic, options = leafletOptions(minZoom = 3, zoomControl = TRUE)) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = states,
    color = "black", weight = 2, fillOpacity = 0, group = "States",
    options = pathOptions(clickable = FALSE)
  ) %>%
  addPolygons(
    fillColor = ~pal_green(civic_opp_category),
    fillOpacity = 0.7, color = "#BDBDC1", weight = 1,
    popup = ~glue("<b>{NAMELSAD}</b><br/>Civic Opportunity Index: {round(civic_opp_index, 2)}"),
    label = ~NAMELSAD
  ) %>%
  addLegend(pal = pal_green, values = map_data_civic$civic_opp_category,
            title = "Civic Opportunity Index", position = "bottomright") %>%
  setView(lng = -95.7129, lat = 37.0902, zoom = 4)

# Create map 2
map2 <- leaflet(map_data_orgtype, options = leafletOptions(minZoom = 3, zoomControl = TRUE)) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = states,
    color = "black", weight = 2, fillOpacity = 0, group = "States",
    options = pathOptions(clickable = FALSE)
  ) %>%
  addPolygons(
    fillColor = ~pal_primary_org(primary_org_type),
    fillOpacity = 0.7, color = "#BDBDC1", weight = 1,
    popup = ~glue("<b>{NAMELSAD}</b><br/>Primary Org Type: {primary_org_type}"),
    label = ~NAMELSAD
  ) %>%
  addLegend(pal = pal_primary_org, values = map_data_orgtype$primary_org_type,
            title = "Primary Organization Type", position = "bottomright") %>%
  setView(lng = -95.7129, lat = 37.0902, zoom = 4)
```

```{css echo=FALSE}
.grid {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}
.g-col-6 {
  flex: 0 0 50%;
}
```

### Civic Opportunity Counts 

```{r}
div(style = "width:100%; height:700px;", map1)
```

### Primary Civic Opportunity Organization Type

```{r}
div(style = "width:100%; height:700px;", map2)
```
