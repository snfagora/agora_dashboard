---
title: "Civic Opportunity Map"
format: html
execute:
  echo: false
  warning: false
  message: false
---

```{r}
# Load necessary packages
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(leaflet, glue, sf, tigris, tidyverse, here, htmlwidgets, viridis, RColorBrewer)

# Load and prepare data
civic_data <- read.csv(here::here("raw_data", "cnty_counts_cov.csv"))
civic_data$fips <- sprintf("%05d", civic_data$FIPS)

counties <- readr::read_rds(here::here("raw_data", "counties.rds"))

# Ensure the CRS is consistent (WGS84) for counties
counties <- st_transform(counties, crs = 4326)  # Reproject counties to WGS84 (EPSG:4326)

# Load the new civic org type data
org_type_data <- read.csv(here::here("raw_data", "cnty_civic_org_type.csv"))

aggregated_data <- org_type_data %>%
  filter(!is.na(class)) %>%  # Filter out rows with NA in 'class'
  group_by(FIPS, class) %>%
  summarise(freq = sum(freq, na.rm = TRUE), .groups = "drop") %>%
  
  # Find the most frequent category (primary org type) for each FIPS
  group_by(FIPS) %>%
  mutate(
    primary_org_type = class[which.max(freq)]  # Get the most frequent class for each FIPS
  ) %>%
  ungroup() %>%
  
  # Select only FIPS and primary org type and ensure uniqueness
  select(FIPS, primary_org_type) %>%
  distinct()

# Step 2: Join civic data with aggregated data first
joined_data <- left_join(civic_data, aggregated_data, by = "FIPS")

# Step 3: Merge the joined data with counties
map_data <- left_join(counties, joined_data, by = c("GEOID" = "fips")) %>%
  st_as_sf() %>%
  st_transform(crs = 4326) %>%
  mutate(
    # Create categories for Civic Opportunity Index
    civic_opp_category = ntile(civic_opp_sum_normalized, 5)
  ) %>%
  mutate(
    civic_opp_rounded_up = round(civic_opp_sum_normalized, 0),
    civic_opp_percentile = percent_rank(civic_opp_sum_normalized),
    civic_opp_percentile_label = case_when(
      civic_opp_percentile >= 0.99 ~ "Top 1%",
      civic_opp_percentile >= 0.95 ~ "Top 5%",
      civic_opp_percentile >= 0.90 ~ "Top 10%",
      civic_opp_percentile >= 0.75 ~ "Top 25%",
      civic_opp_percentile >= 0.50 ~ "Top 50%",
      civic_opp_percentile >= 0.25 ~ "Bottom 50%",
      civic_opp_percentile >= 0.10 ~ "Bottom 25%",
      civic_opp_percentile >= 0.05 ~ "Bottom 10%",
      TRUE ~ "Bottom 5%"
    )
  )

# Simplify geometries to reduce map complexity
map_data <- map_data %>%
  st_simplify(dTolerance = 0.01)  # Adjust the tolerance as needed

# Define more extreme green color palette for Civic Opportunity
pal_green <- colorFactor(c("#D0F1C7", "#4CAF50", "#006400"), domain = map_data$civic_opp_category)  # Really light green, green, really dark green

# Define specific color palette to highlight Religious and Social/Fraternal orgs
pal_primary_org <- colorFactor(
  palette = c(
    "darkgreen",      # Religious
    "gold",           # Social & Fraternal
    "#FF7F00",        # Youth
    "#E41A1C",        # Unions
    "#984EA3",        # Healthcare
    "#377EB8",        # Economic
    "#4DAF4A",        # Education
    "#A65628",        # Research & Think Tank
    "#F781BF",        # Hobby & Sports
    "#999999",        # Community
    "#FFD700",        # Foundations
    "#1E90FF",        # Professional
    "#FB9A99",        # Arts & Cultural
    "#B3DE69",        # Housing
    "#FF69B4"         # Political
  ),
  domain = c(
    "Religious", "Social & Fraternal", "Youth", "Unions", "Healthcare",
    "Economic", "Education", "Research & Think Tank", "Hobby & Sports", 
    "Community", "Foundations", "Professional", "Arts & Cultural", 
    "Housing", "Political"
  )
)


# Render map with both layers
leaflet(map_data, options = leafletOptions(minZoom = 3, zoomControl = TRUE)) %>%
  addProviderTiles("CartoDB.Positron") %>%
  
  # Add Civic Opportunity layer
  addPolygons(
    fillColor = ~pal_green(civic_opp_category),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue("<b>{NAMELSAD}</b><br/>
                   Civic Opportunity Index: {round(civic_opp_index, 2)}<br/>
                   Civic Opportunity Score per 1k: {round(civic_opp_sum_normalized, 2)}<br/>
                   Civic Opportunity Percentile: {civic_opp_percentile_label}"),
    label = ~paste0("County: ", NAMELSAD),
    group = "Civic Opportunity"  # Group by "Civic Opportunity"
  ) %>%
  
  # Add Primary Organization Type layer
  addPolygons(
    fillColor = ~pal_primary_org(primary_org_type),
    fillOpacity = 0.7,
    color = "#BDBDC1",
    weight = 1,
    popup = ~glue("<b>{NAMELSAD}</b><br/>
                   Primary Civic Opportunity Organization Type: {primary_org_type}<br/>
                   Civic Opportunity Index: {round(civic_opp_index, 2)}<br/>
                   Civic Opportunity Score per 1k: {round(civic_opp_sum_normalized, 2)}<br/>
                   Civic Opportunity Percentile: {civic_opp_percentile_label}"),
    label = ~paste0("County: ", NAMELSAD),
    group = "Primary Organization Type"  # Group by "Primary Organization Type"
  ) %>%
  
  # Add Legends for both layers
  addLegend(
    pal = pal_green,
    values = map_data$civic_opp_category,
    title = "Civic Opportunity Index",
    position = "bottomright",
    group = "Civic Opportunity"
  ) %>%
  addLegend(
    pal = pal_primary_org,
    values = aggregated_data$primary_org_type,
    title = "Primary Organization Type",
    position = "bottomright",
    group = "Primary Organization Type"
  ) %>%
  
  # Add Layers Control for toggling between layers
  addLayersControl(
    baseGroups = c("Civic Opportunity", "Primary Organization Type"),  # Layers to toggle
    position = "topright"
  ) %>%
  
  # Set initial view
  setView(lng = -95.7129, lat = 37.0902, zoom = 4)
```